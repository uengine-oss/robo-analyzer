name: "understand_ddl"
description: "DDL 테이블/컬럼/키 분석"
version: "1.1"

input_schema:
  required: []
  optional: {}

prompt: |
  당신은 DDL을 분석하여 테이블과 컬럼, 그리고 외래키 관계를 구조화해 반환합니다.
  
  사용자 언어 설정: {{ locale }}
  
  DDL:
  {{ ddl_content }}
  
  [COMMENT ON 구문 파싱 - 매우 중요]
  DDL에서 테이블/컬럼 설명은 반드시 COMMENT ON 구문에서 추출해야 합니다:
  
  1. 테이블 설명 추출:
     형식: COMMENT ON TABLE [스키마.]"테이블명" IS '설명';
     예시:
       - COMMENT ON TABLE RWIS."RDITAG_TB" IS '태그 마스터 테이블';
       - COMMENT ON TABLE "PUBLIC"."USERS" IS '사용자 테이블';
       - COMMENT ON TABLE orders IS 'Order table';
     → table.comment = 작은따옴표 안의 설명 텍스트
  
  2. 컬럼 설명 추출:
     형식: COMMENT ON COLUMN [스키마.]"테이블명"."컬럼명" IS '설명';
     예시:
       - COMMENT ON COLUMN RWIS."RDITAG_TB"."TAGSN" IS '태그번호';
       - COMMENT ON COLUMN "PUBLIC"."USERS"."EMAIL" IS '이메일 주소';
     → 해당 컬럼의 comment = 작은따옴표 안의 설명 텍스트
  
  3. COMMENT ON 구문과 CREATE TABLE 매핑:
     - COMMENT ON 구문은 CREATE TABLE 뒤에 별도로 정의됨
     - 스키마와 테이블명을 기준으로 CREATE TABLE과 COMMENT ON을 정확히 매핑
     - 큰따옴표(")로 감싼 이름은 따옴표를 제거하고 매칭
     - 스키마가 다르면 다른 테이블로 처리
  
  4. 다중 줄 설명 처리:
     설명에 줄바꿈이나 특수문자가 포함될 수 있음
     작은따옴표 이스케이프: '' (두 개의 작은따옴표)
     예: IS 'User''s data' → comment = "User's data"
  
  5. 스키마 추출 규칙
  - ⚠️ DDL에 스키마가 명시되어 있으면 반드시 추출
    - 스키마 있는 경우: `CREATE TABLE SCHEMA.TABLE` → schema = "SCHEMA"
    - 따옴표 포함: `CREATE TABLE "SCHEMA"."TABLE"` → schema = "SCHEMA" (따옴표 제거)
    - 스키마 없는 경우: `CREATE TABLE TABLE` → schema = "" (빈 문자열)
  - 스키마는 테이블명 앞의 점(.) 구분자 기준으로 추출
  - 스키마가 없다고 추정하지 말고, DDL에 명시된 대로만 추출
  
  [일반 규칙]
  - 추정 금지: DDL에 없는 정보는 추가하지 않음
  - 컬럼명/타입 표기는 DDL 그대로 유지 (대소문자/언더스코어 보존)
  - nullable: NOT NULL 제약이 없으면 true, 있으면 false
  - table_type: CREATE TABLE → "BASE TABLE", CREATE VIEW → "VIEW"
  - 외래키는 DDL 내 FOREIGN KEY ... REFERENCES ... 제약조건에서만 추출
  - 외래키 표기 시 스키마가 없으면 빈 문자열로 처리 ('NULL', 'None' 텍스트 금지)
  - COMMENT ON 구문이 없는 테이블/컬럼의 comment는 빈 문자열("")
  - 테이블/컬럼명에서 추정하지 않음 - 반드시 COMMENT ON 구문에서만 추출
  
  [JSON 출력]
  - 주석 없이, 형식을 엄격히 준수하여 출력
  ```json
  {
    "analysis": [
      {
        "table": {
          "schema": "스키마명 (없으면 빈 문자열)",
          "name": "테이블명",
          "table_type": "BASE TABLE 또는 VIEW",
          "comment": "COMMENT ON TABLE에서 추출한 설명 (없으면 빈 문자열)"
        },
        "columns": [
          {
            "name": "컬럼명",
            "dtype": "데이터타입",
            "nullable": true,
            "comment": "COMMENT ON COLUMN에서 추출한 설명 (없으면 빈 문자열)"
          }
        ],
        "primaryKeys": ["PK컬럼1", "PK컬럼2"],
        "foreignKeys": [
          {"column": "소스FK컬럼명", "ref": "SCHEMA.TABLE.COLUMN"}
        ]
      }
    ]
  }
  ```

