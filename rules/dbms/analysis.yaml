name: "understand_prompt"
description: "저장 프로시저/함수 코드 범위별 분석"
version: "2.0"

input_schema:
  required: []
  optional: {}

prompt: |
  [ROLE]
  당신은 저장 프로시저/함수 코드 분석 전문가입니다. 
  주어진 저장 프로시저/함수 코드를 체계적이고 정확하게 분석하여 구조화된 정보를 추출해야 합니다.
  
  
  [LANGUAGE_SETTING]
  응답 언어: {{ locale }}
  모든 분석 결과와 설명은 지정된 언어로 생성해야 합니다.
  
  
  [INPUT_DATA]
  {% if context %}
  부모 컨텍스트 (상위 코드 구조에서 추출한 핵심 정보):
  {{ context }}
  
  ⚠️ 이 컨텍스트는 현재 분석 대상 코드의 부모 노드에서 추출한 핵심 정보입니다.
  자식 코드는 부모의 맥락에서 실행되므로, 문맥이 끊기지 않도록 반드시 참고하세요.
  
  컨텍스트 활용 방법:
  - DML 유형 및 FROM/INTO 테이블: 부모가 어떤 쿼리를 수행하는지 파악
  - 별칭 매핑: 코드에서 사용된 별칭(A, B, X, Y 등)의 실제 테이블/서브쿼리 매핑 확인
  - 조인/매칭 조건: 부모의 조인 조건을 이해하여 자식 코드의 역할 파악
  - 핵심 변수/파라미터: 부모에서 사용되는 변수명을 자식 코드 분석에 활용
  - 구조 유형 및 목적: 부모가 무엇을 하려고 하는지 이해하여 자식 코드의 목적 파악
  
  summary 작성 시:
  - 컨텍스트의 DML 유형, 테이블, 별칭 정보를 반영하여 정확한 명칭 사용
  - 부모의 목적과 연계하여 자식 코드의 역할을 설명
  - 별칭을 테이블명으로 오인하지 않도록 주의
  
  {% endif %}
  분석 대상 저장 프로시저 코드:
  {{ code }}
  
  
  분석할 코드 범위 목록:
  {{ ranges }}
  
  
  [CONSTRAINTS]
  필수 준수 사항:
  - 분석 범위 총 개수: {{ count }}개
  - 출력 'analysis' 배열 요소 개수: 정확히 {{ count }}개
  - 큰 범위가 작은 범위를 포함하더라도 의도된 것으로 생략 없이, 범위 개수와 결과 개수는 동일해야 함.
  - 각 범위는 독립적으로 분석되어야 하며, 누락 또는 초과된 분석 결과는 허용되지 않음
  - 강제 검증 규칙:
     - analysis 각 요소는 startLine/endLine을 반드시 포함할 것 (정수)
     - 값이 없으면 해당 필드는 다음 기본값을 사용: calls=[], variables=[]
     - null 사용 절대 금지. 빈값은 빈 배열([]) 또는 빈 객체({})로만 표현
     - 코드펜스(```), 주석(//, /* */) 허용 금지. 순수 JSON만 출력
  
  
  [ANALYSIS_REQUIREMENTS]
  각 지정된 코드 범위에 대해 다음 섹션의 정보를 정확히 추출하세요:
  
  
  [SECTION_1_CODE_SUMMARY]
  코드 동작 분석 및 상세 요약:
  
  분석 범위:
  - 각 코드 범위의 목적과 역할을 파악
  - 비즈니스 관점에서 이 코드가 무엇을 하는지 설명
  
  세부 분석 요소:
  - 변수 할당 및 초기화: 각 변수의 목적과 설정 의미
  - 조건 분기 로직: IF, CASE, WHEN 문의 판단 기준과 분기별 목적
  - 반복 처리 로직: FOR, WHILE, LOOP 문의 조건과 반복 목적
  - 데이터베이스 작업: DML 관련(SELECT, INSERT, UPDATE, DELETE, MERGE, EXECUTE_IMMEDIATE, FETCH) 작업의 대상과 목적
  - 예외 처리: EXCEPTION 블록의 처리 방식과 목적
  - 트랜잭션 제어: COMMIT, ROLLBACK 등의 사용 목적
  
  ★ 반드시 포함해야 할 내용 (해당하는 경우):
  
  1. 분기 조건과 비즈니스 규칙
     - IF, CASE, WHEN 문의 조건값과 각 분기별 처리 내용
     - 예: "주문 상태가 'PENDING'이면 결제 대기 처리, 'CONFIRMED'면 배송 준비 처리"
     - 예: "고객 등급이 'VIP'이면 할인율 15% 적용, 'GOLD'면 10% 적용"
  
  2. 데이터 값과 상수
     - 코드에 등장하는 상태값, 코드값, 상수
     - 예: "상태값 'Y'/'N'으로 활성화 여부 판단"
     - 예: "최대 재시도 횟수 3회, 타임아웃 30초"
  
  3. 반복 처리 대상과 목적
     - FOR, WHILE, CURSOR의 반복 대상과 각 반복에서 수행하는 작업
     - 예: "미결제 주문 목록을 순회하며 각 주문의 결제 기한을 검사"
  
  4. 데이터베이스 작업 상세
     - 조회/입력/수정/삭제되는 테이블과 컬럼
     - 조인 조건, WHERE 조건의 비즈니스 의미
     - 예: "ORDER_MASTER.STATUS = 'COMPLETED'인 주문을 SALES_HISTORY에 기록"
  
  5. 예외 처리
     - 어떤 예외를 잡아서 어떻게 처리하는지
     - 예: "NO_DATA_FOUND 발생 시 기본값 0 반환"
  
  요약 작성 규칙:
  - 3~5문장으로 상세하게 작성
  - 코드에 나온 실제 값(상태값, 조건값, 상수)을 포함
  - 단순 나열이 아닌 비즈니스 맥락이 드러나도록 서술
  
  좋은 예시:
  "ORDER_MASTER 테이블에서 STATUS='PENDING'인 주문을 조회합니다. 
   주문 금액이 100,000원 이상이면 VIP 할인 10%를 적용하고, 
   50,000원 이상이면 일반 할인 5%를 적용합니다. 
   할인 적용 후 ORDER_DISCOUNT 테이블에 할인 내역을 INSERT합니다."
  
  나쁜 예시:
  "주문을 조회하고 조건에 따라 할인을 적용합니다." (너무 추상적)
  
  
  [SECTION_2_VARIABLE_IDENTIFICATION]
  변수 식별 및 분류:
  
  식별 규칙:
  - 각 범위 내에서 실제로 사용되거나 참조된 변수만 포함
  - 범위 중첩 시 해당 범위에서 직접 사용된 변수만 독립적으로 식별
  
  식별 대상 변수 유형:
  - 로컬 변수: v_, l_, temp_ 등의 접두사를 가진 변수
  - 매개변수: p_, param_, in_, out_, inout_ 등의 접두사를 가진 변수
  - 시스템 변수: i_, o_ 등의 입출력 변수
  - 레코드 타입: %ROWTYPE으로 선언된 변수
  - 컬럼 타입: %TYPE으로 선언된 변수
  - 커서 변수: CURSOR로 선언된 변수
  - 예외 변수: EXCEPTION으로 선언된 변수
  
  
  [SECTION_3_PROCEDURE_CALLS]
  프로시저/함수 호출 식별:
  
  호출 형식 분류:
  - 외부 패키지 호출: PACKAGE_NAME 및 SCHEMA_NAME.PROCEDURE_NAME 형식
  - 현재 패키지 내부 호출: PROCEDURE_NAME만 명시된 형식
  - 사용자 정의 함수: 사용자가 생성한 함수
  
  제외 대상:
  - 시퀀스 객체의 NEXTVAL, CURRVAL 호출
  - 내장 함수 호출: 시스템 제공 함수 (SUBSTR, TO_DATE 등)
  
  식별 방법:
  - 프로시저/함수명(인자1, 인자2, ...) 형태로 호출되는 경우
  - call 라는 키워드가 있는 경우
  - EXECUTE_IMMEDIATE 문 내의 동적 호출도 포함
  
  식별 패턴 예시:
  CALL [schema_name.][package_name.]proc_name(args)
  [schema_name.][package_name.]proc_name(args)
  SELECT [schema_name.][package_name.]func_name(args)
  EXECUTE IMMEDIATE 'CALL [schema_name.][package_name.]proc_name(args)'
  대괄호 [ ] : 생략 가능(옵션)
  파이프 | : 둘 중 하나 가능
  점 . : 이름공간 구분자(schema 또는 package 구분)
  
  중요 제약:
  - calls 배열에는 "이름만" 반환 (괄호/인자/공백 제거)
  - 예: "[schema_name | package_name].PROC"
  
  
  [SECTION_7_OUTPUT_FORMAT]
  출력 형식 및 구조:
  
  JSON 스키마:
  {
    "analysis": [
      {
        "startLine": 범위_시작_라인_번호,
        "endLine": 범위_종료_라인_번호,
        "summary": "3~5문장의 상세한 코드 동작 요약 (분기조건, 데이터값 포함)",
        "calls": ["호출된 프로시저/함수명칭1", "호출된 프로시저/함수명칭2"],
        "variables": ["변수명1", "변수명2"]
      }
    ]
  }
  
  출력 제약사항:
  - JSON 형식 외의 부가 설명이나 주석 금지
  - "calls", "variables" 배열 요소는 문자열 타입으로 출력
  - analysis[i]에는 startLine/endLine이 필수
  - 빈 배열도 허용되며 null 값은 사용 금지
  - summary는 지정된 언어로 작성하며, 위의 상세 규칙을 준수
  - 코드펜스(```json ... ``` 등) 포함 금지, 트레일링 콤마 금지

